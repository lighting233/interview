# 缓存

## 一、DNS 缓存

DNS缓存的查找过程是DNS解析过程中优化性能的一部分，通过缓存可以减少查询的次数，加快域名解析速度。DNS缓存存在于多个层次，从用户的计算机到权威DNS服务器，每一层都有可能缓存之前查询过的DNS记录。

### DNS缓存查找的层次与过程

1. **浏览器缓存**
   - **检查位置**: 用户的Web浏览器可能会缓存最近访问过的域名及其对应的IP地址。
   - **缓存内容**: 当用户再次访问同一域名时，浏览器会首先查找其缓存。如果缓存中有该域名的记录且未过期，浏览器会直接使用缓存中的IP地址，跳过后续的DNS查询过程。
   - **有效期**: 这个缓存的有效期通常较短，一般是几分钟到几小时。

2. **操作系统缓存（DNS Resolver Cache）**
   - **检查位置**: 如果浏览器缓存中没有找到该域名的记录，查询请求会被转发到操作系统的DNS解析器（DNS Resolver）。操作系统也会维护一个缓存表，存储最近查询过的域名及其对应的IP地址。
   - **缓存内容**: 操作系统缓存中如果有该域名的记录且未过期，它会将IP地址返回给浏览器。
   - **有效期**: 操作系统缓存的有效期也由TTL值决定，通常可以配置。

3. **路由器的DNS缓存**

4. **本地DNS服务器缓存（递归解析器缓存）**
   - **检查位置**: 如果操作系统缓存也没有找到对应记录，查询请求会发送到本地DNS服务器（通常是由互联网服务提供商（ISP）提供的递归解析器）。
   - **缓存内容**: 本地DNS服务器缓存之前处理过的域名解析记录，如果缓存中有该域名的记录且未过期，它会将IP地址返回给操作系统和浏览器。
   - **有效期**: 本地DNS服务器的缓存通常具有较长的有效期，但同样由DNS记录中的TTL值控制。

5. **从根服务器递归查询到权威DNS服务器**
   - **检查位置**: 如果本地DNS服务器的缓存中也没有该域名的记录，查询请求最终会到达权威DNS服务器。虽然权威DNS服务器本质上不缓存数据（它们是数据的权威来源），但它们可以利用缓存减少对根域名服务器或顶级域名服务器的查询。
   - **缓存内容**: 权威DNS服务器的查询结果本身是“权威”的，但为了提高效率，它们可能缓存一些非权威数据，例如上游查询的结果。

### DNS缓存查找过程的简化图示

```
用户输入域名
       ↓
浏览器缓存 —— 查找是否有记录
       ↓
操作系统缓存 —— 查找是否有记录
       ↓
路由器 —— 查找是否有记录
       ↓
本地DNS服务器缓存 —— 查找是否有记录
       ↓
权威DNS服务器 —— 返回IP地址
```

### TTL（生存时间，Time To Live）
- **TTL**: 每一条DNS记录都有一个TTL值，它决定了缓存记录在缓存中的存活时间。TTL过期后，缓存记录将被删除，下一次请求将发起新的DNS查询。

### 小结

- **浏览器缓存** 是查询的第一层，用于加速同一域名的重复访问。
- **操作系统缓存** 是查询的第二层，管理系统级别的域名解析。
- **路由器** 
- **本地DNS服务器缓存** 是查询的第四层，服务于网络内的所有设备。
- **权威DNS服务器** 提供最终的权威响应，如果前几层缓存都没有命中，它将给出IP地址。

每一层的缓存都会在查询过程中依次被检查，直到找到有效的DNS记录，避免不必要的网络请求和延迟。