[TOC]
# 浏览器

## 一、进程（process）与线程（thread）
---
可以通过一个比喻来形象地说明计算机中的进程和线程之间的区别。

### 比喻：餐厅和厨师

**进程**就像是一家餐厅，而**线程**则是餐厅里的厨师。

#### 进程（餐厅）

1. **独立性**：每个餐厅都是独立的，拥有自己的空间、设备和资源。例如，餐厅有自己的厨房、餐桌和菜单。不同餐厅之间是相互隔离的，彼此的运营不会直接影响对方。

2. **资源分配**：每个餐厅需要申请和管理自己的资源，比如水电、食材和员工。这些资源是餐厅生存和运营的基础。

3. **开销**：开设一个新的餐厅需要较大的开销，例如租金、装修和设备采购。这也意味着创建和销毁进程的开销比较大。

#### 线程（厨师）

1. **共享性**：餐厅里的厨师（线程）可以共享厨房的设备和食材（进程的资源）。多个厨师可以在同一个厨房中工作，协同完成不同的菜品。

2. **轻量级**：比起开设新的餐厅，增加一个厨师的成本要小得多。添加一个新线程（厨师）相对开销较小，因为它们共享进程的资源。

3. **并发性**：多个厨师可以同时工作，快速完成订单。线程的并发执行使得程序能够更高效地利用 CPU 资源。

### 总结

- **餐厅（进程）** 是一个独立的单位，拥有自己的资源和环境。
- **厨师（线程）** 是在餐厅内部工作的单元，可以共享资源并高效地协同工作。

通过这个比喻，可以更好地理解进程和线程的区别：进程是资源的独立管理单位，而线程是执行的基本单位，具有共享和协作的特性。

### 开启一个应用程序也可能会开启多个进程
而在**应用程序**中，为了满足功能的需要，启动的进程会**创建另外的新的进程**来处理其他任务，这些创建出来的新的进程拥有全新的独立的内存空间，不能与原来的进程内向内存，如果这些进程之间需要**通信**，可以通过**IPC**机制（Inter Process Communication）来进行。

---

## 二、浏览器的多进程架构

---

### 1.浏览器是⼀个多进程的架构，为何使⽤多进程架构?

- 由于多个线程共享着相同的**地址空间**和**资源**,所以会存在线程之间有可能会恶意修改或者获取⾮授权数据等复杂的**安全问题**。

#### 单进程浏览器：
 1. 不稳定。单进程中的插件、渲染线程崩溃导致整个浏览器崩溃。
 2. 不流畅。脚本（死循环）或插件会使浏览器卡顿,各个任务相互竞争抢夺CPU资源，使得浏览器响应速度变慢。
 3. 不安全。插件和脚本可以获取到操作系统任意资源。

#### 多进程浏览器:

1. 解决不稳定。更高的容错性,进程相互隔离，⼀个⻚⾯或者插件崩溃时，影响仅仅时当前插件或者⻚⾯，不会影响到其他⻚⾯。
2. 解决不流畅。脚本阻塞当前⻚⾯渲染进程，不会影响到其他⻚⾯。
3. 解决不安全。采⽤多进程架构使⽤沙箱。沙箱看成是操作系统给进程上来⼀把锁，沙箱的程序可以运⾏，但不
能在硬盘上写⼊任何数据，也不能在敏感位置读取任何数据.
4. ==多进程充分利用多核优势==

>将渲染进程和OS隔离的这道墙就是安全沙箱。
作⽤：利⽤OS提供的安全技术，让渲染进程在执⾏过程中⽆法访问或修改OS中的数据，在渲染进程需要访问系统资源的时候，需通过浏览器内核实现，将访问结果通过IPC转发给渲染进程。
最⼩的保护单位是进程。单进程浏览器需要频繁访问或修改OS的数据，所以单进程浏览器⽆法被安全沙箱保护

### 2.在Chrome中，主要的进程有4个

1. **浏览器进程** (Browser Process)：负责浏览器的TAB的前进、后退、地址栏、书签栏的工作和处理浏览器的一些不可见的底层操作，比如网络请求和文件访问。
   1. UI thread：控制浏览器上的按钮及输入框；
   2. storage thread： 控制文件等的访问；
2. **渲染进程** (Renderer Process)：负责一个Tab内的显示相关的工作，也称渲染引擎。
3. **插件进程** (Plugin Process)：负责控制网页使用到的插件
4. **GPU进程** (GPU Process)：负责处理整个应用程序的GPU任务
5. **⽹络进程**: 从浏览器进程中独⽴出来的, 主要负责⻚⾯的⽹络资源加载。
>但在较新的版本中，网络请求通常在渲染进程中处理

### 3.渲染进程都包括哪些线程？
1. **主线程（GUI 线程）：**
负责处理页面的渲染、JavaScript 执行和 DOM 操作。
>负责渲染⻚⾯，解析 html、css；构建 DOM 树和渲染树；当界⾯需要重绘(Repaint)或由于某种操作引发回流(reflow)时,该线程就会执⾏。在Javascript引擎运⾏脚本期间,GUI渲染线程都是处于挂起状态的,也就是说被”冻结”了.

2. **JS引擎线程**

3. **工作线程：**
用于执行 Web Workers 和其他异步任务。这些线程可以并行处理任务，避免阻塞主线程。
在 Chrome 中，事件触发线程和定时触发器线程可以被视为工作线程的一部分。具体来说，它们的功能如下：

   1. **事件触发线程**：
   - 处理各种事件，例如用户输入、网络请求的响应等。这些事件通常会被放入事件队列中，当主线程空闲时，事件触发线程会从队列中取出事件并执行相应的回调。

   2. **定时触发器线程**：
   - 处理定时器相关的任务，例如 `setTimeout` 和 `setInterval` 的回调。当定时器到期时，定时触发器线程会将相关的回调函数放入事件队列，以便主线程在合适的时候执行。

4. **合成线程**：合成不同渲染层的位图。
5. **多个光栅化线程**：将渲染层转换为位图。
6. **I/O线程**：管理渲染进程与浏览器主进程之间的通信，处理网络资源请求。

### 4.为了节省内存，Chrome提供了四种进程模式（Process Models），不同的进程模式会对 tab 进程做不同的处理。

1. Process-per-site-instance (default) - 同一个 site-instance 使用一个进程。
满足下面两中情况并且打开的新页面和旧页面属于上面定义的同一个 site，就属于同一个 site-instance
  - 用户通过 `<a target="_blank">` 这种方式点击打开的新页面
  - JS代码打开的新页面（比如 window.open)
2. Process-per-site - 同一个 site 使用一个进程
3. Process-per-tab - 每个 tab 使用一个进程
4. Single process - 所有 tab 共用一个进程

#### 那么为什么浏览器使用Process-per-site-instance作为默认的进程模式呢？
Process-per-site-instance兼容了性能与易用性，是一个比较中庸通用的模式。

- 相较于 Process-per-tab，能够少开很多进程，就意味着更少的内存占用
- 相较于 Process-per-site，能够更好的隔离相同域名下毫无关联的 tab，更加安全


### 5.site（站点），domian（域名），同源的区别

1. **Site（站点）**
定义：通常指一个网站的整体，包括所有的页面和资源。相同的 domain 和相同的scheme（位于URL的开头，‌即`://`之前的部分"http"就是scheme）为同一个 site。
示例：https://www.example.com 是一个站点，包含该域名下的所有页面和资源。比如a.baidu.com和b.baidu.com就可以理解为同一个 site

2. **Domain（域名）**
定义：是一个用于标识一个网站在互联网上位置的名称。它是站点的地址。
示例：在 https://www.example.com 中，example.com 是域名。子域名 www 是域名的一部分。

3. **同源（Same-Origin）**
定义：同源策略是浏览器的一种安全机制，限制不同源之间的交互。两个 URL 被认为是同源的，如果它们具有相同的协议、域名和端口。
示例：
https://www.example.com/page1 和 https://www.example.com/page2 是同源的。
https://www.example.com 和 http://www.example.com 不是同源的（协议不同）。
https://www.example.com 和 https://sub.example.com 也不是同源的（域名不同）。

### 一个域名可以对应多个 IP 地址。以下是一些可能的场景：

1. **单个域名对应一个 IP 地址**
常见情况：在最简单的情况下，一个域名对应一个唯一的 IP 地址。这通常发生在小型网站或不需要复杂负载均衡和高可用性的情况下。
- 例子：example.com 可能只解析到一个 IP 地址，比如 192.0.2.1。
2. **单个域名对应多个 IP 地址**
负载均衡：为了分散流量压力，域名可以解析到多个 IP 地址，这些 IP 地址通常对应多个服务器。这种方法叫做负载均衡，可以通过 DNS 轮询（DNS round-robin）或其他负载均衡技术来实现。
高可用性：为了确保网站的高可用性，域名可以指向不同地理位置的多个服务器的 IP 地址。如果其中一个服务器出现故障，流量可以自动切换到其他服务器。
- 例子：example.com 可以同时解析到 192.0.2.1 和 192.0.2.2 两个 IP 地址，当用户访问这个域名时，流量会根据负载均衡策略分配到不同的服务器上。

3. **多个域名对应同一个 IP 地址**
虚拟主机：在虚拟主机环境中，多个域名可以共享一个 IP 地址，服务器通过查看请求的 Host 头来决定向哪个网站提供服务。
CDN（内容分发网络）：多个域名可能解析到同一个 CDN 的 IP 地址，CDN 会根据请求的域名来提供不同的内容。
- 例子：example1.com 和 example2.com 可以都解析到 192.0.2.1，通过服务器配置来区分不同域名的请求。

---
## 三、浏览器的本地存储
---

## 四、浏览器的操作面板
---

## 五、浏览器对事件的处理
[浏览器对事件的处理-渲染进程中合成器线程接收事件-浏览器对事件的优化](https://juejin.cn/post/6844904175067725838#heading-23)
1. UI线程接收事件
2. Browser Process只知道事件发生的类型和发生的位置
3. Browser Process接受到事件后，随后便把事件的信息传递给了渲染进程
4. 渲染进程会找到根据事件发生的坐标，找到目标对象（target），并且运行这个目标对象的点击事件绑定的监听函数（listener）。
