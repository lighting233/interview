# 性能优化
[启动时性能优化](https://juejin.cn/post/7140509513852911647?searchId=202410121122031906A9EB56637937A22B#heading-41)
分为「启动性能」和「运行时性能」两个主题

## 启动性能优化

### 1.微信的内部优化
1. **小程序相关信息准备**: 微信客户端需要从微信后台获取小程序的头像、昵称、版本、配置、权限等基本信息，这些信息会在本地缓存，并通过一定的机制进行更新。
2. **环境预加载**: 为了尽可能的降低运行环境准备对启动耗时的影响，微信客户端会根据用户的使用场景和设备资源的使用情况，依照一定策略在小程序启动前对运行环境进行部分地预加载，以降低启动耗时。
3. **代码包准备**: 
   1. 从微信后台获取代码包地址，从 CDN 下载小程序代码包
   2. 小程序代码包会在本地缓存，并通过更新机制进行更新。同步下载/异步下载 强制更新/静默更新
   3. 为例降低代码包下载的耗时，微信做的一些优化
      - 代码包压缩
      - 增量更新
      - 优先使用QUIC 和HTTP/2 
      - 预先建立连接：在下载发生前，提前和 CDN 建立连接，降低下载过程中 DNS 请求和连接建立的耗时
      - 代码包复用：对每个代码包都会计算 MD5 签名。即使发生了版本更新，如果代码包的 MD5 没有发生变化，则不需要重新进行下载。
4. 代码注入:小程序启动时需要从代码包内读取小程序的配置和代码，并注入到 `JavaScript` 引擎中。微信客户端会使用 V8 引擎的 `Code Caching` 技术对代码编译结果进行缓存，降低非首次注入时的**编译耗时**
5. 首屏渲染优化
   1. 启用「初始渲染缓存」: 启用初始渲染缓存，可以使视图层不需要等待逻辑层初始化完毕，而直接提前将页面初始 data 的渲染结果展示给用户，这可以使得页面对用户可见的时间大大提前
   2. 提前首屏数据请求: 预拉取能够在小程序冷启动的时候通过微信后台提前向第三方服务器拉取业务数据，当代码包加载完时可以更快地渲染页面，减少用户等待时间，从而提升小程序的打开速度;周期性更新能够在用户未打开小程序的情况下，也能从服务器提前拉取数据，当用户打开小程序时可以更快地渲染页面，减少用户等待时间，增强在弱网条件下的可用性。
### 2.开发者应做的优化
1. 推荐所有小程序使用分包加载
2. 避免非必要使用全局自定义组件和插件: 会影响按需注入的效果和小程序代码注入的耗时
3. 控制资源文件:建议开发者在代码包内的图片一般应只包含一些体积较小的图标，避免在代码包中包含或在 WXSS 中使用 base64 内联过多、过大的图片等资源文件。
4. 这类文件应尽可能部署到 CDN，并使用 URL 引入。
5. 为自定义组件配置 占位组件，组件就会自动被视为用时注入组件:在使用如 分包异步化 或 用时注入 等特性时，自定义组件所引用的其他自定义组件，在刚开始进行渲染时可能处于不可用的状态。此时，为了使渲染过程不被阻塞，不可用的自定义组件需要一个 「占位组件」（Component placeholder）。基础库会用占位组件替代不可用组件进行渲染，在该组件可用后再将占位组件替换回该组件
6. 启动过程中减少同步 API 的调用
   1. 建议优先使用拆分后的 `getSystemSetting/getAppAuthorizeSetting/getDeviceInfo/getWindowInfo/getAppBaseInfo` 按需获取信息，或使用使用异步版本 `getSystemInfoAsync`
   2. `getStorageSync/setStorageSync` 应只用来进行数据的持久化存储，不应用于运行时的数据传递或全局状态管理。
## 运行时性能优化
1. 合理使用`setData`:控制频率，范围，内容: 我们的数据传输实际是一次 `evaluateJavascript` 脚本过程，当数据量过大时会增加脚本的编译执行时间，占用 WebView JS 线程
2. 页面渲染优化
   1. 适当监听scroll 事件
   2. 控制 WXML 节点数量和层级
   3. 源码中一个页面dom 数目超过16000，肯定会报错
   4. data层级不要过深，因为需要深度遍历
   5. 使用 `IntersectionObserver` 监听元素曝光
3. 页面切换优化
   1. 避免在 onHide/onUnload 执行耗时操作:页面切换时，会先调用前一个页面的 onHide 或 onUnload 生命周期，然后再进行新页面的创建和渲染
   2. 提前发起数据请求
     - 进行页面跳转时（例如 wx.navigateTo），可以提前为下一个页面做一些准备工作。页面之间可以通过 EventChannel 进行通信。类似postMessage
     - 例如，在页面跳转时，可以同时发起下一个页面的数据请求，而不需要等到页面 onLoad 时再进行，从而可以让用户更早的看到页面内容。
   3. 控制预加载下个页面的时机
    - 程序页面加载完成后，会预加载下一个页面。默认情况下，小程序框架会在当前页面 onReady 触发 200ms 后触发预加载。
    - 预加载会阻塞当前页面`setData`，我们可以对单个页面的配置增加， `handleWebviewPreload` 选项，来控制预加载下个页面的时机。
4. 内存优化
   - 合理分包，既能减少耗时，也能降低内存占用
   - 事件监听，定时器记得清除
